<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ë–∞–ª–ª—ã –ê–Ω–∂–µ–ª–∏–∫–∏</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
    h1, h2 { text-align: center; }
    .section {
      background: white; padding: 20px; margin: 20px auto; max-width: 800px;
      border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table { width: 100%; border-collapse: collapse; }
    td, th { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f0f0f0; }
    input[type="number"] { width: 80px; }
    .actions { text-align: right; }
    button { padding: 8px 16px; margin: 10px 0; cursor: pointer; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinning { display: inline-block; animation: spin 1s linear infinite; }
  </style>
</head>
<body>
<div id="auth-section" style="text-align: center; margin-bottom: 20px;">
  <button id="authorize_button">\u0412–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  <button id="signout_button" style="display:none;">\u0412—ã–π—Ç–∏</button>
</div>
<h1>\ud83d\udc3e \u0411–∞–ª–ª—ã –ê–Ω–∂–µ–ª–∏–∫–∏ <button id="syncButton">\ud83d\udd04</button></h1>
<div class="section" id="balance"><h2>\u0422–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <span id="currentPoints">\ud83d\udc3e –∑–∞–≥—Ä—É–∑–∫–∞...</span></h2></div>
<div class="section" id="taskSection"><h2>\u2705 \u0412—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2><div id="taskList"></div></div>
<div class="section" id="storeSection"><h2>\ud83c\udf6d \u041c–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥</h2><div id="storeList"></div></div>
<div class="section" id="penaltySection"><h2>\u274c \u0428—Ç—Ä–∞—Ñ—ã</h2><div id="penaltyList"></div></div>
<div class="section" id="adminSection">
  <h2>\ud83d\udc68‚Äç\ud83d\udc69‚Äç\ud83d\udc67 \u041f–∞–Ω–µ–ª—å —Ä–æ–¥–∏—Ç–µ–ª—è</h2>
  <div>
    <label>\u041d–∞–∑–≤–∞–Ω–∏–µ: <input id="nameInput" type="text"></label><br>
    <label>\u0422–∏–ø:
      <select id="typeInput">
        <option value="\u0417–∞–¥–∞–Ω–∏–µ">\u0417–∞–¥–∞–Ω–∏–µ</option>
        <option value="\u041f–æ–∫—É–ø–∫–∞">\u041f–æ–∫—É–ø–∫–∞</option>
        <option value="\u0428—Ç—Ä–∞—Ñ">\u0428—Ç—Ä–∞—Ñ</option>
      </select>
    </label><br>
    <label>\u0411–∞–ª–ª—ã: <input id="valueInput" type="number"></label><br>
    <div class="actions">
      <button onclick="addRecord()">\u0414–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>
<script>
  const CLIENT_ID = '113185812719-b2mcqg5h8maj48fa3rfudpbnr759se0u.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyDsipEo6CcgcyaeXYGkzHUBfUvLYsCGLDg';
  const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
  let tokenClient, gapiInited = false, gisInited = false, —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ = [], currentPoints = 0;
  document.getElementById('authorize_button').onclick = handleAuthClick;
  document.getElementById('signout_button').onclick = handleSignoutClick;
  document.getElementById('syncButton').addEventListener('click', loadSheetData);
  function gapiLoaded() { gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
    gapiInited = true; maybeEnableButtons(); loadSheetData(); }
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID, scope: SCOPES, callback: '',
    });
    gisInited = true; maybeEnableButtons();
  }
  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('authorize_button').style.display = 'block';
    }
  }
  function handleAuthClick() {
    tokenClient.callback = async (resp) => {
      if (resp.error !== undefined) throw resp;
      document.getElementById('signout_button').style.display = 'block';
      document.getElementById('authorize_button').style.display = 'none';
      await listSheetData();
    };
    tokenClient.requestAccessToken({ prompt: 'consent' });
  }
  function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
      google.accounts.oauth2.revoke(token.access_token);
      gapi.client.setToken('');
      document.getElementById('authorize_button').style.display = 'block';
      document.getElementById('signout_button').style.display = 'none';
    }
  }
  async function listSheetData() {
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: '1Te4VEluOKgLJ-tusx1EJWzL2G2QuFIJrMf2cMD1ESJQ',
        range: 'Main!A2:C'
      });
      —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ = res.result.values.map(row => ({
        type: row[0], name: row[1], value: parseInt(row[2])
      })).filter(r => !isNaN(r.value));
      render();
    } catch (e) { console.error('–û—à–∏–±–∫–∞:', e); }
  }
  function render() {
    document.getElementById("taskList").innerHTML = renderTable("–ó–∞–¥–∞–Ω–∏–µ");
    document.getElementById("storeList").innerHTML = renderTable("–ü–æ–∫—É–ø–∫–∞");
    document.getElementById("penaltyList").innerHTML = renderTable("–®—Ç—Ä–∞—Ñ");
    updateBalance();
  }
  function renderTable(type) {
    return `<table><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ë–∞–ª–ª—ã</th><th></th></tr>` +
      —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫.filter(r => r.type === type).map(r =>
        `<tr><td>${r.name}</td><td>${r.value}</td><td><button onclick='applyPoints(${r.value})'>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></td></tr>`
      ).join('') + `</table>`;
  }
  function applyPoints(val) {
    currentPoints += val;
    updateBalance();
  }
  function updateBalance() {
    document.getElementById("currentPoints").innerText = `${currentPoints} üêæ`;
  }
  function addRecord() {
    const name = document.getElementById("nameInput").value.trim();
    const type = document.getElementById("typeInput").value;
    const value = parseInt(document.getElementById("valueInput").value);
    if (!name || isNaN(value)) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
    —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫.push({ type, name, value });
    render();
    gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: '1Te4VEluOKgLJ-tusx1EJWzL2G2QuFIJrMf2cMD1ESJQ',
      range: 'Main!A:C',
      valueInputOption: 'RAW',
      resource: { values: [[type, name, value]] }
    }).then(r => console.log('–î–æ–±–∞–≤–ª–µ–Ω–æ', r), e => console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏', e));
  }
  function loadSheetData() {
    document.getElementById('syncButton').innerHTML = '<span class="spinning">üêæ</span>';
    gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: '1Te4VEluOKgLJ-tusx1EJWzL2G2QuFIJrMf2cMD1ESJQ',
      range: '–ë–∞–ª–∞–Ω—Å!A2:B2'
    }).then(resp => {
      const values = resp.result.values;
      if (values?.length) {
        document.getElementById("currentPoints").innerText = `üêæ ${values[0][1]}`;
      }
      document.getElementById('syncButton').innerText = 'üîÑ';
    });
  }
  window.onload = () => {
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.onload = gapiLoaded;
    document.body.appendChild(gapiScript);

    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.onload = gisLoaded;
    document.body.appendChild(gisScript);
  };
</script>
</body>
</html>
